[<- До підрозділу](README.md)

# Програмування на мові Grafcet в в EcoStruxure Machine Expert - Basic

## Основи Grafcet

Мова **SFC (Sequential Function Charts)** – графічна мова програмування, в якій поведінка системи задається:

\- послідовністю кроків, де описуються необхідні дії;

\- переходів між кроками, які задаються умовами. 

SFC також відома під назвою **Grafcet**, та крім стандарту IEC 61131 описана також в IEC 848. Основою для розробки SFC стали **мережі Петрі** – математичний апарат для моделювання поведінки динамічних систем. Зовнішній вигляд та елементи SFC показані на рисунку нижче. 

![](mediam221/6_02.jpg)



Основними елементами SFC є **кроки (Step)**, **переходи (Transition)** та **зв’язки (Link)**.  Всі елементи (кроки, переходи) організовують **мережу SFC** (подібно мережі Петрі). 

- **STEP**: Крок виконує набір дій, визначених в одному або в декількох rungs, написаних на будь яких мовах програмування. Кроки можуть бути:
  - *Початковий крок*: виконується на початку програми або після перезапуску контролера. 
  - *Звичайний крок*: кроки, які умовно виконуються після завершення першого кроку, завершують виконання.
- **Transition**: логічний вираз, який перевіряється між кроками. Це зв'язок між двома або більше кроками

Кроки поєднуються між собою тільки через переходи, які в свою чергу теж не можуть безпосередньо з’єднуватися між собою. Таким чином зв’язки можуть бути тільки між кроками та переходами. У момент активності кроку він володіє **маркером (Token)**. Коли крок активний (тобто володіє маркером) виконуються **дії (Action)** що описані в кроці. Перехід пропускає через себе маркер тоді, коли справджується **умова переходу (Transition Condition).** 

Мережі SFC можуть мати лінійну структуру або містити альтернативні та паралельні гілки, які організовані відповідними типами розходження та сходження.

![](mediam221/6_03.jpg)



Наступна схема є прикладом лінійної програми SFC з початковим кроком, одним звичайним кроком, і двома переходами:

1. Початковий крок.
2. Перехід від кроку 1 до кроку 2.
3. Звичайний крок.
4. Перехід із кроку 2 назад до кроку 1. На посилання з'являється стрілка, яка вказує на порядок кроку

![](mediam221/6_04.jpg)



## Функціонування Grafcet

Порядок виконання логічним контролером програми SFC:

1. Починається основний цикл робіт.
2. POU, які передують першому кроку Grafcet (SFC), виконуються послідовно.
3. Перший крок SFC запускає Grafcet monitor .
4. Коли Grafcet monitor закінчує виконання програми, запускається перший POU, який слідує за останнім кроком Grafcet (SFC).



Поведінка Grafcet monitor – опис роботи програми :

1. Логічний контролер обробляє системні біти SFC %S21,%S22 та %S23.

2. Логічний контролер оновлює стан активації кожного кроку Grafcet (SFC).

- Кроки, позначені як деактивовані, деактивуються.
- Активуються кроки, позначені для активації.
- Кроки, позначені для активації та деактивації одночасно, будуть залишаться активованими.
- Списки активації та деактивації скидаються.

3. Логічний контролер сканує кроки (цикл від найменшого заданого номера кроку до найвищого визначеного). Якщо сканований крок активний, починає виконуватись відповідний код кроку.

4. Коли код переходу активізує або деактивує крок, ця дія розміщується відповідно в список активації або деактивації для наступного циклу завдань.

5. Коли виконується останній активний код кроку, Grafcet monitor закінчується.



Bits ControllingGrafcet (SFC):

%S21 - Grafcet Initialization - при встановленні значення 1 крок ініціалізації стає активним;

%S22 - Grafcet reset - при встановленні значення 1 активний крок деактивується і виконання перезапускається;

%S23 - Preset and Freeze Grafcet - при встановленні значення 1 виконання програми зупиняється аж до моменту коли значення не стане 0;

%xi - Grafcet steps - Біти %X1 до %Xi пов'язані з кроками. Значення 1 показує на активність кроку, 0 на те що крок не активний. Даний біт доступний лише для читання.



## Графічний редактор Grafcet

Графічний редактор Grafcet містить сітку комірок. Кожна клітина містить один крок, один перехід, або обидва. Мінімальний розмір програми - це один крок. Максимальна кількість кроків для програми становить 96.

![](mediam221/6_08.jpg)



###### Додати кроки

Двічі клацніть у будь-якій комірці сітки, щоб додати крок, або клацніть правою кнопкою миші у будь-якій комірці сітки та виберіть «Add a step». Ви можете перемістити крок, перетягнувши його в іншу комірку сітки.

![](mediam221/6_09.jpg)



Перший крок, створений у Grafcet Graphical Editor, за замовчуванням є початковим кроком. Програма повинна містити хоча б один початковий крок. Можна визначити більш ніж один початковий. Щоб змінити тип кроку (початковий/звичайний), клацніть правою кнопкою миші на кроці та виберіть «Установити / вимкнути як початковий крок».

![](mediam221/6_10_2.jpg)



###### Створення переходів

З'єднайте кроки, щоб визначити порядок виконання кроків. Щоб створити перехід між двома кроками необхідно:

1. Навести на нижню частину кроку, поки не з'явиться зелена лінія.
2. Натиснути на цю лінії і з'єднати з потрібним кроком для створення переходу

![](mediam221/6_11.jpg)



Програмування кроку можливе в одному або декількох rung IL/Ladder програмах. Двічі клацніть на кроці графічного редактора Grafcet. 

1. Виберіть вузол кроку у перегляді дерева, де n - номер кроку. Результат: Grafcet Графічний редактор закритий.
2. Клацніть правою кнопкою миші на вибраному кроці та виберіть команду «Add rung» з контекстного меню. Результат: у вікні управління проекту під кроком з'явиться створений rung.
3. Створіть необхідну програму на будь якій мові, а також додайте додаткові rung при необхідності.



Програмування переходу можливе в одному або декількох rung IL/Ladder програмах.

1. Двічі клацніть на переході в графічному редакторі Grafcet або виберіть перехід дереві проекту. Результат: Grafcet Графічний редактор закритий.
2. Вкажіть необхідні умови. Вкінці рангу необхідно виконати інструкцію ENDT. Саме вона означатиме що умова переходу спрацювала 

![](mediam221/6_13.jpg)



###### **Розгалуження**

Програма SFC може містити розгалуження. Існує два типи розгалуження:

1. Паралельне розгалуження: два або більше етапів обробляються одночасно, коли попередній перехід істинний.
2. Альтернативне розгалуження: обробляється один або декілька альтернативних етапів залежно від результату попередніх умов переходу



Паралельне відгалуження забезпечують розділення маркеру між паралельними гілками при спрацюванні єдиної умови переходу. 

-  Паралельна гілка дозволяє переходити від одного кроку до декількох кроків;
-  Паралельне відгалуження має передувати і слідувати кроком;
-  Паралельні гілки можуть містити вкладені альтернативні гілки або інші паралельні гілки.

![](mediam221/6_15.jpg)



Альтернативне відгалуження забезпечують передачу маркера в ту гілку програми, умова переходу якого спрацює раніше. Альтернативне відгалуження позначається одинарною лінією, з відповідною кількістю гілок (від 2-х).

-  Альтернативне відгалуження дозволяє розділити програму на декілька варіантів, виконання яких будуть визначатися умовою переходу;
-  Альтернативна гілка повинна починатися і закінчуватися переходом;
-  Альтернативні гілки можуть містити вкладені паралельні гілки або інші альтернативні гілки.

![](mediam221/6_16.jpg)

## Відео

<iframe width="800" height="600" src="https://www.youtube.com/embed/ENCt_tSWKcs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>



Теоретичне заняття розробив [Прізвище або нік розробника Імя](https://github.com). 
