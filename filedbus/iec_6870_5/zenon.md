[<- До підрозділу](README.md)

# Налаштування драйверу IEC 60870 в SCADA zenon

## Загальні налаштування

![img](C:\san\народн посібн атпв\gitver\filedbus\iec_6870_5\media\16193.png)

Опція `Deactivate standard DPI/DCS value mapping`

- Не виставлена (за замовчуванням): значення подвійних повідомлень (DPI та DCS) налаштовані відповідно до операційних елементів zenon. Використовуйте цю конфігурацію, якщо необхідно використовувати функціональні можливості zenon Energy Edition. Драйвер перетворює значення подвійних повідомлень (DPI та DCS) для Service Engine: `intermediate` | `off` | `on` | `fault` в : `2` | `0` | `1` | `3` , так що в Service Engine значення 0 означає, наприклад, OFF , а 1 означає ON.

- Виставлена: значення подвійних повідомлень пересилаються до zenon точно такими, якими вони є: `intermediate` | `off` | `on` | `fault`
  = `0` | `1` | `2` | `3`.  Однак у цьому випадку не можна використовувати обробку команд, наприклад, для запису подвійних повідомлень.

Варто зауважити, що драйвер перетворює лише значення змінної, яке відповідає діапазону значень DPI/DCS. DPI/DCS складається, згідно зі стандартом, з 2 бітів; всі інші біти змінної не передаються.

Поле `Directory for file transfer` містить шлях на комп’ютері Service Engine, у якій мають зберігатися файли, які отримуються веденим пристроєм IEC60870 (GET).

Поле `Directory for file transfer in Control Direction` містить шлях до папки, в якій знаходяться файли, які надсилаються (PUT) на ведений пристрій IEC60870.

Значення `Maximum time difference for clock synchronisation` встановлює максимальне відхилення часу, яке запускає синхронізацію часу у системі zenon. Якщо драйвер отримує `ASDU<103>` (у зворотному напрямку) з часом, відмінним від установленого на локальному ПК, і різниця отриманого часу менша за значення, встановлене для цієї властивості, драйвер змінює час на локальному ПК. Якщо різниця в часі перевищує встановлене значення, драйвер не синхронізує годинник ПК. Встановлення значення 0 запобігає синхронізації часу на ПК у зворотному напрямку. За замовчуванням: 60 с

Опція `Not topical as invalid` вказує чи треба відобразити стан змінної IEC 870 біт `NT_870` (`not topical`) у змінну zenon .

- вситавлена: якщо драйвер zenon отримує змінну IEC 870 зі статусом `Not Topical`, для змінної zenon також встановлюється біт стану 18 (`INVALID`). У результаті змінна відповідно позначається під час відображення в Service Engine, якщо в конфігурації проекту активовано властивість елемента `Display status of variable`.
- не виставлена: біт статусу `INVALID` також не відображається на змінній zenon.

Опція `Overflow as invalid` вказує чи треба відобразити біт статусу змінної IEC 870 `OV_870` (`Overflow`) у змінну zenon.

- виставлена: якщо драйвер zenon отримує змінну IEC 870 зі статусом `Overflow`, для змінної zenon також встановлюється біт стану 18 (INVALID). У результаті змінна відповідно позначається під час відображення в Service Engine, якщо в конфігурації проекту було активовано властивість `Display status of variable`

- не виставленя: біт статусу INVALID також не відображається на змінній zenon.

Опція `Initialize command variables` вказує чи Ініціалізувати командні змінні IEC870 значенням і бітом стану.

- виставлена: під час ініціалізації всім змінним команди (ідентифікатор типів `45–63`) присвоюється значення `0` із активованим бітом стану `NT`. Якщо активовано `remanent image`, значення командних змінних зберігаються, а їхні значення та статуси відновлюються під час запуску.

- не виставлена: командні змінні ініціалізуються без значення та біта стану.

## Налаштування Connections

Налаштування передбачає дворівневу архітектуру, де на верхньому рівні розміщені пристрої, до яких треба підключатися (Devices), а на нижньому логічні сектори (Sectors).

- Devices
- Sectors. Увага: налаштовані сектори повинні бути присутніми в ПЛК.

![img](C:\san\народн посібн атпв\gitver\filedbus\iec_6870_5\media\16195.png)

### Device

Підключення до Пристрою складається з підключення фізичного пристрою та кількох секторів загальної адреси ASDU в цьому пристрої. Як і будь який пристрій в zenon кожен пристрій IEC 870 ідентифікується через логічний `Net address`. Він у свою чергу відповідає зв'язаний з налаштовуваним для протоколу `Link address` або IP-адресу.

![img](C:\san\народн посібн атпв\gitver\filedbus\iec_6870_5\media\16194.png)

`Device name` - назва пристрою, що відображається у списку пристроїв. Також під час онлайн-імпорту це ім’я стає частиною імені імпортованої змінної.

Опція `Reverse Direction` - означує, чи активний зворотний напрямок для цього підключення. 

- виставлена: змінні надсилаються у зворотному напрямку. `EOI` не надсилається, доки не буде встановлено з’єднання, включаючи загальний запит для всіх з’єднань.
- знято (за замовчуванням): немає зв'язку у зворотному напрямку.

### Application layer

У цій частині налаштовуються опції для прикладного рівня драйвера. Тут необхідно виставити конфігурацію, яка співпадає з пристроєм, до якого відбувається підключення. Якщо конфігурація неправильна, то зв’язку з пристроєм не буде.

- `ASDU COT size` - Означує довжину COT (причина передачі). Вибір розміру адреси з розкривного списку. Для типу з’єднання 60870-5-104 (TCP/IP), відповідно до стандарту очікується значення 2 октети .

- `ASDU COA size` - Означує довжину COA (загальна адреса об’єкта/загальна адреса ASDU). Якщо для рівня зв’язку вибрано тип з’єднання 60870-5-104 (TCP/IP), відповідно до стандарту очікується значення 2 октети .

- `ASDU IOA size` - Вибір розміру адреси IOA (Адреса інформаційного об'єкта). Якщо для рівня зв’язку вибрано тип з’єднання 60870-5-104 (TCP/IP),  відповідно до стандарту очікується значення 3 октети.

- `Originator` - ідентифікаційний номер головного пристрою IEC60870 (від 0 до 255), який надсилається пристрою при надсиланні команд, щоб той міг визначити від якого Ведучого пристрою прийшла команда і кому відповідно передавати відповідь (якщо через цю комунікацію передають дані кілька Ведучих).  Це значення відправника надсилається тільки в тому випадку, якщо для ASDU COT-Size налаштовано значення 2 октети. Типове значення: 0. Якщо для ASDU COT-Size налаштовано значення 1 октет, поле неактивне. 

- `UTC Timestamps` - якщо прапорець виставлений для команди очікується або використовується позначка часу у форматі UTC (наприклад, синхронізація часу `T103`), інакше сприймається як місцевий час відповідно до стандарту. Згідно стандарту IEC60870 всі компоненти повинні використовувати місцевий час а не UTC.

### Link layer

У цій частині налаштовуються зв’язок з послідовним портом або через TCP/IP. Варто зауважити що у контексті IEC104 процедури сеансу та безпеки побудовані над транспортним рівнем (TCP), тоді як у IEC101 процедури сеансу та безпеки побудовані над канальним рівнем.

Для IEC101 вказується адреса пристрою через  `link adsress`. 

Для IEC104 вказується IP адреса та порт. Якщо передбачається резервування, то додаткові налаштування вказуються в `Secondary Connection`.    При цьому вказується `Redundancy mode`, який означує тип зв'язку з основним і резервним сервером у разі резервування. Тут є кілька варіантів:

- `Alternative channel (data link)`  - спочатку встановлюється з'єднання з Веденим, якщо з'єднання переривається і повторне з'єднання не вдається, встановлюється з'єднання з другим Веденим. Дане налаштування не відповідає стандарту 

- `Acc. IEC 60870-5-104 Ed. 2(data link)` - відбувається підключення до обох налаштованих IP-адрес які утворюють групу резервування.
  Ця поведінка означена стандартом IEC 60870-5-104, версія 2.0. Її треба виставляти лише за умови що пристрій підтримує вказівки версії 2.0 щодо резервування підключення. 
- `Both channels active (application)` - драйвер обмінюється даними одночасно з основною та резервною IP-адресами. Отримані значення приймаються обома з’єднаннями та надсилаються до середовища виконання zenon. Телеграми в командному напрямку завжди надсилаються на обидва з'єднання. Для цього режиму резервування є також опція `No START_DT on Secondary Server`, яка вказує на необхідність обміну з резервним сервером у режимі резервування серверів zenon. Якщо опція встановлена то обмін даними здійснюється лише з основним сервером, за винятком тестових кадрів. START_DT не надсилається на вторинний сервер, поки він не стає основним. Якщо знята то дані передаються і на резервний сервер.  

Група налаштувань `Timing parameters` призначена для виставлення часових параметрів:

- `T1` - час очікування у мілісекундах для підтвердження надісланих кадрів. Якщо протягом `T1` кадр ASDU або APCI не підтверджується, це вважається помилкою з’єднання. Діапазон значень: 0 - 4294967295 Типове значення: 15000 мс

- `T2` - час очікування в мілісекундах, протягом якого має відбутися підтвердження через S-кадр (APCI), якщо не було обміну даними (через ASDU). Діапазон значень: 0 - 4294967295. За замовчуванням: 10000 мс. Відповідно до стандарту IEC 60870-5-104, `T2` має бути меншим за `T1` і однаковим на Ведучому та Веденому.

- `T3` - час очікування у мс для тестових кадрів - періодичних U-кадрів (APCI) для тестового етапу підключення, якщо немає обміну даними (через ASDU). Діапазон значень: 0 - 4294967295. За замовчуванням: 20000 мс. Процедура перевірки відбувається у фоновому режимі. Якщо кадр `TestFR` не підтверджено протягом `T1`, це вважається помилкою підключення. Тому доцільно встановити `T3` > `T1`. Виняток: для резервних з’єднань відповідно до версії 2.0 стандарту IEC 60870-5-104 рекомендується скоротити `T3` на стороні Ведучого (наприклад, 5s).

- `K` - максимальна кількість I-кадрів, для яких ще не отримано підтвердження. Якщо кількість `k` невиконаних підтверджень перевищено, це розпізнається як помилка підключення. Діапазон значень: 0 - 4294967295 За замовчуванням: `12` . 

- `W` – максимальна кількість I-кадрів, отриманих до моменту відправлення підтвердження. Значення `w` має бути менше `k`. Діапазон значень: 0–4294967295. Типове значення: `8`.  

Зверніть увагу, що Ведучий і Ведений  мають використовувати однакове значення `w` і`k`!  У мережах швидкого Ethernet може бути доцільним збільшити параметри `k` і `w` (у Ведучому та Веденому) в  `10` або `100` разів, наприклад. `k=120`, `w=80`. Це може збільшити продуктивність.

Зверніть увагу. Відповідно до стандарту IEC 60870-5 підлеглий пристрій 870 для кожного сектора (COA) і напрямку передачі (напрямок моніторингу або управління) може мати лише один інформаційний об’єкт (IO) з певною адресою IOA. Значення IO може, залежно від причини передачі (COT), передаватися в повідомленнях ASDU з тегом часу або без нього. Приклад: передача виконується один раз як T01 на основі загального запиту, потім як T02 або T30 у разі спонтанної зміни значення. Усі ці три ідентифікатори типу є одноточковою інформацією з міткою часу (тегом часу) або без неї. Таким чином, ці три ідентифікатори типу сумісні один з одним. Проте IO не повинен змінювати кодування значення, наприклад, з T01 - single на T03 - double. Якщо в драйвері IEC870 (основному) створено декілька змінних, які мають однакові COA , IOA та напрямок передачі, це може призвести до небажаних дій у zenon. Приклад: підтримується така поведінка:

- Дві змінні: сигнал T01 (напрямок моніторингу) і команда T45 (напрямок керування) з однаковою адресою COA та IOA. Зазвичай і рекомендовано, щоб команда та відповідь від інформаційного об’єкта мали однакові адреси COA та IOA.

- Змінна T01: містить значення інформаційного об’єкта з міткою часу або без неї. Драйвер передасть значення та мітку часу (якщо доступна) з ASDU з T01 (інформація про значення), або T02, або T30 (події з тегом часу) до змінної. Таким чином, для змінних, створених через онлайн-імпорт, немає необхідності вручну змінювати властивість Type ID на IO з тегом часу. (через онлайн-імпорт означає загальний запит, який надсилає IO без мітки часу.)

Наведене нижче підтримується обмежено: Кілька змінних з різними ідентифікаторами типу в напрямку передачі з однаковою адресою COA та IOA.
Якщо виникає ASDU із COA та IOA, то отримане значення, біти стану та позначка часу передаються до всіх змінних із цим COA/IOA та ідентифікаторами сумісного типу. Ви можете знайти список ідентифікаторів типів, для яких є 3 сумісні варіанти, у вузлі  Allocation of the data types node.
Примітка: це стосується zenon версії 8.10. У попередніх версіях значення надавалися лише одній зі змінних, а всі інші змінні з адресацією ігнорувалися.

Параметри `TLS settings` задаються в окремому вікні.

![img](C:\san\народн посібн атпв\gitver\filedbus\iec_6870_5\media\277406.png)



### Sector

Кожен `Device` може містити декілька секторів. Сектор ідентифікується за допомогою його загальної адреси об’єкта (`COA`), яка також називається загальною адресою ASDU і може містити кілька точок даних — інформаційних об’єктів (IO).

Для кожного `Device` має бути означено принаймні один `Sector`. Драйвер ігнорує всі ASDU (кадри з даними), які надсилає `Device`  (підлеглий пристрій 870), якщо ASDU містить `COA`, який не належить до жодного попередньо означеного Сектора. Починаючи зв’язок із Пристроєм, драйвер надсилає загальний (станційний) запит - `C_IC_NA_1` - виключно для COA означених секторів.

![img](C:\san\народн посібн атпв\gitver\filedbus\iec_6870_5\media\16035.png)

COA - Загальна адреса об’єкта, також відома (в IEC 60870-5-101 7.2.4) як загальна адреса ASDU, за допомогою якої адресується сектор. Цей номер видається виробником пристрою (870 slave), знаходиться в області 1..254 (`0xFE`) або 1..65534 (`0xFFFE`), залежно від розміру CAO slave. Примітка: COA `0xFF`(`FF`) інтерпретується деякими Веденими як широкомовна трансляція. Усі сектори, налаштовані в діалоговому вікні драйвера (COA), повинні бути присутніми в пристрої! Якщо означено сектор, який не існує в Веденому пристрої, початковий загальний запит (`C_IC_NA_1`) не буде виконано.

## Налаштування адреси змінних

Окремі точки даних – інформаційні об’єкти – адресуються через вказівку:

- COA (загальна адреса об’єкта = загальна адреса ASDU) що вказує на сектор на Пристрої, у якому знаходяться дані 
- ідентифікацією типу інформаційного об'єкту IEC 60870 (Type identification), який означує потрібну функцію (що робити з даними) та можливі значення змінної (див. список сумісності). Усі типи мають номери, в налаштуваннях змінної для вказівки типу використовується формат `Tx`, де `x` - номер типу 
- IOA (інформаційна адреса об’єкта) означує зсув даних у цьому секторі

Для створення змінних, які відображають інформаційні об’єкти з ідентифікацією типу<1..37>, драйвер підтримує онлайн-імпорт.

Для змінних zenon налаштування адреси для IEC870 відрізняється від налаштування інших змінних. Такі поля як `Data block` , `Offset` , `Alignment`, `Bit number` , `Driver connection/Priority`, не застосовні, натомість використовуються спеціальні властивості, характерні для цього драйверу. Властивості `Name` та `Identification` мають ті самі призначення як і для змінних інших драйверів. `Net address` - аналогічно до інших типів підключення, це логічна адреса пристрою для вказівки підключеного пристрою. Нижче наведені властивості, характерні змінним саме для цього типу драйверу.

![image-20250107233907687](C:\san\народн посібн атпв\gitver\filedbus\iec_6870_5\media\image-20250107233907687.png)

- `IEC870 Type identification` Означує напрямок зв’язку, тип і функцію змінної відповідно до специфікації IEC 60870. Можна надати ідентифікатор типу `with time tag` та  `with time tag CP56Time2a` та без мітки часу в діапазоні `T01..T37`. Наприклад, якщо змінну було створено з типом одноточкової інформації `T01`, драйвер може приймати від пристрою як значення без мітки часу для неї, так і з нею, тобто `T02` або `T30`. У zenon значення, які отримані з міткою часу записують цю мітку часу як мітку часу змінної zenon. Примітка, Type ID `T00` (`Internal state`) передбачено для додаткових, специфічних для драйвера функцій.

- `IEC870 COA` - загальна адреса об'єкта (загальна адреса ASDU), яка вказує на сектор пристрою, в якому знаходиться змінна. 

- `IEC870 IOA` - Адреса інформаційного об'єкта, тобто зміщення змінної в межах сектора (COA). Діапазон значень IOA залежить від розміру IOA ASDU: від 0/1 до 255, або 65535, або 16777215 (розмір IOA 3 октети). Для інформаційних об’єктів з ідентифікацією типу `1..64` значення `0` IOA не має значення відповідно до стандарту IEC 60870.

- `IEC870 private Index` - ця властивість стосується лише змінних із ідентифікатором типу в приватному діапазоні, наприклад `T160`. Типове значення: `0`

- `Driver connection/Driver Object Type` - Тип об'єкта змінних. Залежно від драйвера, який використовується, вибирається під час створення змінної та може бути змінений тут. За замовчуванням: `PLC marker`

- `Driver connection/Data Type` - Тип даних змінної. 

- `Read from Standby Server only` -  Джерело значення змінної для відображення в zenon, якщо проект використовується в резервній мережі zenon. Якщо опція виставлена, то змінна візуалізує значення з драйвера, який працює на резервному сервері. Значення з основного сервера не відображаються.

## Типи об'єктів драйверу та типи даних

Об’єкти драйвера – це області, які доступні в пристрої. Нижче наведено, які об’єкти драйвера надаються драйвером і які типи даних IEC можна призначити відповідним об’єктам драйвера.

### Об'єкти драйвера

У цьому драйвері доступні такі типи об’єктів: 

| Тип об'єкта драйвера  | Тип  каналу | Читання                                                      | Запис                                                        | Підтримувані типи                                       | Comment                                                      |
| --------------------- | ----------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------- | ------------------------------------------------------------ |
| PLC marker            | 8           | Значення та біти стану командної змінної оновлюються під час отримання ASDU з підтвердженням (COT_actcon(7) та/або COT_actterm(10) тощо). | Драйвер підтримує зв'язок у зворотному напрямку для змінних `T30` і `T31` з активною властивістю `write set value`. | BOOL, SINT, USINT, INT, UINT, DINT, UDINT, REAL, STRING | Змінні, які відповідають інформаційним об’єктам у пристрої та мають `T00` (внутрішній стан). Ідентифікатор типу:<br />-`1..37`, `126`, `136..141` – отримання/читання<br />-`45..103`, `122`, `160` – запис |
| Communication details | 35          | +                                                            | +                                                            | BOOL, SINT, USINT, INT, UINT, DINT, UDINT, REAL, STRING | Змінні для статичного аналізу комунікації; Значення передаються між драйвером і Service Engine, а не до пристрою. Примітка: адресація та поведінка однакові для більшості драйверів zenon. |

Термін `channel type` є внутрішнім числовим описом типу об’єкта драйвера. Він також використовується для розширеного імпорту/експорту змінних DBF. `channel type`  використовується для розширеного імпорту/експорту CSV змінної в стовпці `HWObjectType`.

### Відображення типів даних

Відображення типів даних з ПЛК на типи даних zenon

| IEC 60870 short name                    | ASDU Type ID | Data type | Кодування значення (відповідно до IEC 60870) / коментар      | Data type  |
| --------------------------------------- | ------------ | --------- | ------------------------------------------------------------ | ---------- |
| M_SP_NA_1                               | 1            | BOOL      | SPI <0..1>single-point information                           | 8          |
| M_SP_TA_1                               | 2            | BOOL      | SPI single-point information with time tag (CP24Time2a)      | 8          |
| M_SP_TB_1                               | 30           | BOOL      | SPI single-point information with time tag (CP56Time2a)      | 8          |
| M_DP_NA_1                               | 3            | USINT     | DPI <0..3> with Mapping of Double Point Values double-point information | 9          |
| M_DP_TA_1                               | 4            | USINT     | DPI with Mapping of Double Point Values (CP24Time2a)         | 9          |
| M_DP_TB_1                               | 31           | USINT     | DPI with Mapping of Double Point Values (CP56Time2a)         | 9          |
| M_ST_NA_1                               | 5            | USINT     | Corresponds to whole VTI (IEC60870-5-101 7.2.6.5). Bit 8 is the Transient bit.step position information | 9          |
| M_ST_TA_1                               | 6            | USINT     | VTI (CP24Time2a)                                             | 9          |
| M_ST_TB_1                               | 32           | USINT     | VTI (CP56Time2a)                                             | 9          |
| M_BO_NA_1                               | 7            | UDINT     | BSI (32 bits)bitstring of 32 bits                            | 4          |
| M_BO_TA_1                               | 8            | UDINT     | BSI (CP24Time2a)                                             | 4          |
| M_BO_TB_1                               | 33           | UDINT     | BSI (CP56Time2a)                                             | 4          |
| M_ME_NA_1                               | 9            | REAL      | NVA <–1..+1 –2–15>, in practice <-1..0,9999>measured value, normalized value | 5          |
| M_ME_TA_1                               | 10           | REAL      | NVA (CP24Time2a)                                             | 5          |
| M_ME_TD_1                               | 34           | REAL      | NVA (CP56Time2a)                                             | 5          |
| M_ME_NB_1                               | 11           | INT       | SVA <–215..+215–1> = <-32768..32767>measured value, scaled value | 1          |
| M_ME_TB_1                               | 12           | INT       | SVA (CP24Time2a)                                             | 1          |
| M_ME_TE_1                               | 35           | INT       | SVA (CP56Time2a)                                             | 1          |
| M_ME_NC_1                               | 13           | REAL      | R32measured value, short floating point number               | 5          |
| M_ME_TC_1                               | 14           | REAL      | R32 (CP24Time2a)                                             | 5          |
| M_ME_TF_1                               | 36           | REAL      | R32 (CP56Time2a)                                             | 5          |
| M_IT_NA_1                               | 15           | DINT      | BCR.Counter reading <-231..+231-1>integrated totals          | 3          |
| M_IT_TA_1                               | 16           | DINT      | BCR.Counter reading (CP24Time2a)                             | 3          |
| M_IT_TB_1                               | 37           | DINT      | BCR.Counter reading (CP56Time2a)                             | 3          |
| C_SC_NA_1                               | 45           | BOOL      | SCSsingle command                                            | 8          |
| C_SC_TA_1                               | 58           | BOOL      | SCS (CP56Time2a)                                             | 8          |
| C_DC_NA_1                               | 46           | USINT     | DCS with Mapping of Double Point Values double command       | 9          |
| C_DC_TA_1                               | 59           | USINT     | DCS (CP56Time2a) with Mapping of Double Point Values         | 9          |
| C_RC_NA_1                               | 47           | USINT     | RCSregulating step command                                   | 9          |
| C_RC_TA_1                               | 60           | USINT     | RCS (CP56Time2a)                                             | 9          |
| C_SE_NA_1                               | 48           | REAL      | NVAset point command, normalized value                       | 5          |
| C_SE_TA_1                               | 61           | REAL      | NVA (CP56Time2a)                                             | 5          |
| C_SE_NB_1                               | 49           | INT       | SVAset point command, scaled value                           | 1          |
| C_SE_TB_1                               | 62           | INT       | SVA (CP56Time2a)                                             | 1          |
| C_SE_NC_1                               | 50           | REAL      | R32set point command, short floating point number            | 5          |
| C_SE_TC_1                               | 63           | REAL      | R32 (CP56Time2a)                                             | 5          |
| C_BO_NA_1                               | 51           | UDINT     | BSI (32 bits)bitstring of 32 bits command                    | 4          |
| C_BO_TA_1                               | 64           | UDINT     | BSI (CP56Time2a) (32 bits)                                   | 4          |
| C_IC_NA_1                               | 100          | BOOL      | 1 during execution(general) interrogation command            | 8          |
| C_CS_NA_1                               | 103          | BOOL      | 1 during executionclock synchronization command              | 8          |
| C_RP_NA_1                               | 105          | USINT     | QRP reset process command                                    | 9          |
| F_SC_NA_1                               | 122          | STRING    | Command for file transfer, for example “DIR” or “GET”        | 12         |
| F_DR_TA_1                               | 126          | STRING    | Response variable for file transfer "DIR" result             | 12         |
| private range, in monitoring direction  | 135..141     | Numerical | Addressing for Siemens-specific private Type ID area:<br />-135 - USINT, a diagnosis byte from error telegram with component sums.<br />-136 - USINT, a DPI. From received ASDU, the driver also maps the 2-bit fields to the value of the variable:Bit SL (switching action running) - PROGRESS status bit.Bit SF (switching case) - CB_TRIP status bit.If the CB_TR_I status bit is set for the variable, the bit SF is ignored.<br />-137 - BOOL x 16; the array with SPI, with IEC870 private Index: 0..15.<br />-138 - USINT x 8; the array with DPI, with IEC870 private Index: 0..7.<br />-139 - USINT x 4; the array with DPI with SF and SL bits; with IEC870 private Index: 0..3.<br />140 - DINT - as M_ME_TE_1 (T35) but with double length (4 bytes).<br />-141 - UINT - as M_BO_TB_1 (T33) but with only the half of the length (bitstring with 16 bits). | 9, 8, 3, 2 |
| private range, in controlling direction | 160          | BOOL      | Command with factor and time stated in Siemens-specific private Type ID area, Variable with IEC870 private Index: property <br />- 0..15 - index is command number; with factor 0, time 0;<br />- Index 100..115 - corresponds to command number 0..15 with factor 20, time 0;<br />- Index 150..165 - command number 0..15 with factor 30, time 0. | 8          |

- Тег часу CP24Time2a містить лише mm:ss.ms; використовується для мітки часу змінної, за допомогою якої драйвер використовує годинник ПК, щоб доповнити відсутню інформацію. Якщо значення хвилин вище, ніж на годиннику ПК, драйвер автоматично повертає час на одну годину назад.
- Для мітки часу змінної використовується  тег часу CP56Time2a використовується .
- Тип ID приватної зони (private range) - це типи, які не передбачені стандартом IEC 60870, тому залежать від виробника. Драйвер підтримує підгрупу приватних форматів контролерів Siemens.

- ASDU Type ID: Ідентифікація типу IEC60870-5-101, відповідає властивості змінної «Ідентифікація типу IEC870».
- Data type - номер ідентифікатору типу zenon

#### Виділення кількох змінних або кількох ідентифікаторів типу

У напрямку керування драйвер надсилає ASDU з точним ідентифікатором типу змінної, для якої відбувся запис встановленого значення. Пристрій надсилає назад ASDU з підтвердженням команди. Драйвер оцінює ASDU для всіх змінних з однаковою адресацією (COA та IOA) та ідентичним ідентифікатором типу. 

У напрямку монітора драйвер розподіляє значення, мітку часу та біти стану всім змінним, у яких COA та IOA відповідають адресації отриманого повідомлення ASDU, якщо ідентифікація типу в ASDU сумісна з властивістю Type ID змінної.

Ідентифікатори типів (у діапазоні `T01..T37`), які відрізняються лише кодуванням інформації про час (тег часу), сумісні. У таблиці типів даних IEC ідентифікатори типу мають однакову ідентифікацію для кодування значення, наприклад: DPI.

Якщо змінну було створено з ідентифікатором типу в діапазоні `T01..T37`, драйвер приймає для неї значення з міткою часу та без мітки часу від пристрою, наприклад ASDU типу `*_NA_1`, `*_TA_1` і `*_TB_1`.  У zenon значення, отримані з тегом часу, отримують зовнішню позначку часу, наприклад. У проекті для даних з певного контролера було створено 3 змінні з однаковими адресами COA та IOA:

- `var1`: BOOL з `T01` (одноточкова інформація)
- `var2`: USINT з `T30` (одноточкова інформація з тегом часу CP56Time2a)
- `var3`: USINT з `T03` (подвійна інформація) (не сумісний)

Якщо драйвер отримує ASDU з `T02` (одноточкова інформація з тегом часу), він оновлює значення, біти стану та позначку часу змінних `var1` і `var2`. Однак, оскільки змінна `var3` має ідентифікатор типу, який не сумісний із ASDU, вона не оновлюється. Для `var3` драйвер реєструє попередження «Отримано ідентифікацію несумісного типу».



## Онлайн імпорт з пристрою

Змінні можна створити за допомогою онлайн-імпорту з драйвера в напрямку повідомлення (T01..T37). Ви повинні створити змінні для команд (T45..T64) вручну, оскільки в протоколі IEC 60870 команди є лише для запису. Неможливо прочитати їх адресу за допомогою контролера. Примітка. Стандарт IEC 60870 пропонує означити адресацію COA + IOA команди так само, як і адресацію повідомлення, до якого застосовується команда. Багато виробників контролерів також дотримуються цієї пропозиції стандарту. Якщо контролер дотримується цього принципу, ви можете після онлайн-імпорту змінних напрямку повідомлення генерувати змінні для команд, копіюючи імпортовані змінні та налаштовуючи копії властивості type ID, наприклад, копія повідомлення T01 -> команда T45.

Процес імпорту

1) У драйвері налаштуйте підключення до контролера та закрийте діалогове вікно налаштування драйвера.

2) Виберіть команду Імпортувати змінні з драйвера в контекстному меню драйвера в списку драйверів.

3) У діалоговому вікні виберіть підключення, з якого ви хочете прочитати змінні:

![img](C:\san\народн посібн атпв\gitver\filedbus\iec_6870_5\media\23765.png)

Після того, як ви натиснули кнопку OK, драйвер надсилає загальний запит (GI - «команда загального запиту») на вибраний пристрій. Цей загальний запит виконується для всіх налаштованих секторів (CAO).

![img](C:\san\народн посібн атпв\gitver\filedbus\iec_6870_5\media\23766.png)

4) Якщо загальні опитування секторів контролера завершені, усі інформаційні об’єкти (IO), що містяться в них, зіставляються в список. Якщо, поки поточні загальні опитування ще не завершено, контролер також спонтанно (або циклічно) надсилає ASDU, включені в них IO також враховуються драйвером. Причина передачі (COT) у ASDU та значення або статус IO не мають жодного впливу під час імпорту; драйвер лише збирає інформацію про адресування.

Драйвер автоматично генерує пропозиції для імен змінних - з ідентифікатора з'єднання та з адресації, отриманої пристроєм: Type ID, COA і IOA. Діалогове вікно для вибору змінних для імпорту:

![img](C:\san\народн посібн атпв\gitver\filedbus\iec_6870_5\media\23767.png)

Список міститься інформаційних об'єктів (IO) знаходиться у верхній частині діалогового вікна; змінні, які ви вибрали як змінні для імпорту (створення), знаходяться в нижній частині.

1. Двічі клацніть запис IO або виберіть запис IO + кнопку Add, щоб додати IO до нижнього списку змінних, які потрібно імпортувати.
2. Натисніть кнопку OK, щоб створити вибрані змінні - у нижньому списку діалогового вікна - у проекті zenon.



Теоретичне заняття розробив [Олександр Пупена](https://github.com/pupenasan). 



Про проект народного посібника "Автоматизація технологічних процесів та виробництв" і як допомогти проекту читайте [у описі проекту](../../README.md)